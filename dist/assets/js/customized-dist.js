"use strict";function clickBlank(){$(document).on("click",function(){$(".tool-btn").removeClass("open"),$(".tool-btn .tool-setting").fadeOut(300),$(".color-select").fadeOut(300)})}function setCanvasSize(e){var t=$(".drawing-paper").innerWidth(),a=$(".drawing-paper").innerHeight();customizedCanvas[e].canvas.setWidth(t),customizedCanvas[e].canvas.setHeight(a),customizedCanvas[e].cursorCanvas.setWidth(t),customizedCanvas[e].cursorCanvas.setHeight(a)}function addPaperBackground(o,e,s){var r=void 0,i=void 0,n=$(".artboard-background").innerWidth(),l=$(".artboard-background").innerHeight();r=$(".artboard-background").position().left,i=$(".artboard-background").position().top,"upload"!==s?fabric.Image.fromURL(e,function(e){customizedCanvas[o].canvas.add(e.set({left:r,top:i,selectable:!1,objType:"paperBG",objFrom:s}).scale(n/e.width))}):fabric.Image.fromURL(e,function(e){var t=void 0,a=void 0;e.width>=e.height?(t=n/e.width,a=(l-e.height*t)/2,i+=a):e.width<e.height&&(t=l/e.height,a=(n-e.width*t)/2,r+=a),customizedCanvas[o].canvas.add(e.set({left:r,top:i,selectable:!1,objType:"paperBG",objFrom:s}).scale(t))}),$('.drawing-paper[data-page="'+o+'"]').addClass("paper-initialize"),setTimeout(function(){customizedCanvas[o].data.state=customizedCanvas[o].canvas.toJSON()},500)}function resizeBG(){var e=$(".drawing-paper.show").attr("data-page"),t=$(".artboard-background").innerWidth(),a=$(".artboard-background").position().left,o=$(".artboard-background").position().top;setCanvasSize(e),customizedCanvas[e].canvas.getObjects()[0].set({left:a,top:o,selectable:!1}).scale(t/customizedCanvas[e].canvas.getObjects()[0].width),defaultViewport=customizedCanvas.default.canvas.viewportTransform}function fabricInit(e){function t(i){return function(e,t,a,o,s){var r=this.cornerSize;e.save(),e.translate(t,a),e.rotate(fabric.util.degreesToRadians(s.angle)),e.drawImage(i,-r/2,-r/2,r,r),e.restore()}}var a=document.createElement("img");a.src="data:image/svg+xml,%0A%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'%3E%3Cdefs%3E%3Cstyle%3E.cls-1%7Bfill:%23191919;%7D.cls-2%7Bfill:%23fff;%7D%3C/style%3E%3C/defs%3E%3Ctitle%3Edelete%3C/title%3E%3Cg id='圖層_2' data-name='圖層 2'%3E%3Cg id='圖層_1-2' data-name='圖層 1'%3E%3Ccircle class='cls-1' cx='15' cy='15' r='15'/%3E%3Cpath class='cls-2' d='M15.94,15l3.87-3.87a.66.66,0,1,0-.94-.94L15,14.06l-3.87-3.87a.66.66,0,0,0-.94.94L14.06,15l-3.87,3.87a.68.68,0,0,0,0,.94.68.68,0,0,0,.94,0L15,15.94l3.87,3.87a.68.68,0,0,0,.94,0,.68.68,0,0,0,0-.94Z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E";var o=document.createElement("img");o.src="data:image/svg+xml,%0A%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 29.99 29.99'%3E%3Cdefs%3E%3Cstyle%3E.cls-1%7Bfill:%23191919;%7D.cls-2%7Bfill:%23fff;%7D%3C/style%3E%3C/defs%3E%3Cg id='圖層_2' data-name='圖層 2'%3E%3Cg id='圖層_1-2' data-name='圖層 1'%3E%3Ccircle class='cls-1' cx='15' cy='15' r='15'/%3E%3Cpath class='cls-2' d='M21.24,10,20,8.74a1.37,1.37,0,0,0-1.88,0L16.85,10,9.74,17.11a0,0,0,0,1,0,0l-.07.11,0,0v0L8.38,21a.45.45,0,0,0,.42.59.32.32,0,0,0,.14,0l3.76-1.25h.05l.11-.08h0L20,13.13l1.25-1.26A1.33,1.33,0,0,0,21.24,10ZM9.5,20.48l.75-2.24,1.49,1.5Zm3.06-1.18-1.64-1.64-.24-.24,6.49-6.49,1.31,1.32.57.57Zm8.06-8-.94.94-1.32-1.32-.56-.56.94-.94a.44.44,0,0,1,.62,0l1.26,1.25A.45.45,0,0,1,20.62,11.25Z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E";var s=document.createElement("img");s.src="data:image/svg+xml,%0A%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'%3E%3Ctitle%3Erotate%3C/title%3E%3Cg id='af6903dc-9d92-47db-8945-07df3dda9f89' data-name='圖層 2'%3E%3Cg id='7fcac64a-eca7-464b-8ade-f941a38eb16d' data-name='圖層 1'%3E%3Crect width='30' height='30' rx='15' ry='15' fill='%23fff'/%3E%3Cpath d='M17.5,10,15,7.5V9.17a6.67,6.67,0,1,0,6.67,6.66H20a5,5,0,1,1-5-5V12.5Z' fill='%23050a0f'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E";var r=fabric.controlsUtils,i=r.scaleSkewCursorStyleHandler,n=fabric.Object.prototype.controls;if(fabric.Object.prototype.set({cornerStyle:"circle",cornerSize:10,borderColor:"#7e7e7e",cornerColor:"#9a9a9a",transparentCorners:!1,padding:10,borderOpacityWhenMoving:1}),n.mtr=new fabric.Control({x:0,y:-.5,cursorStyle:'url("https://mingleurn1987.com/dist/assets/img/customized/control-rotate.png"), auto',actionHandler:r.rotationWithSnapping,cursorStyleHandler:r.rotationStyleHandler,offsetY:-64,withConnection:!0,actionName:"rotate",render:t(s),cornerSize:30}),n.deleteControl=new fabric.Control({x:.5,y:-.5,offsetX:24,offsetY:-30,cursorStyle:"pointer",mouseUpHandler:function(e,t){isEdit=!(isDeleted=!0);var a=t.canvas;a.remove(t),a.discardActiveObject(),a.renderAll()},render:t(a),cornerSize:30}),n.editControl=new fabric.Control({x:.5,y:-.5,offsetX:24,offsetY:12,cursorStyle:"pointer",mouseUpHandler:function(e,t){var a=t.text;$(".mobile-text-input .text-input").val(a).focus(),$(".mobile-text-input").addClass("open")},render:t(o),cornerSize:30}),fabric.Textbox){var l=fabric.Textbox.prototype.controls={};l.mtr=n.mtr,l.tr=n.tr,l.br=n.br,l.tl=n.tl,l.bl=n.bl,l.mt=n.mt,l.mb=n.mb,l.mr=new fabric.Control({x:.5,y:0,actionHandler:r.changeWidth,cursorStyleHandler:i,actionName:"resizing"}),l.ml=new fabric.Control({x:-.5,y:0,actionHandler:r.changeWidth,cursorStyleHandler:i,actionName:"resizing"}),l.deleteControl=n.deleteControl,l.editControl=n.editControl}$(e).each(function(){var x=this,e=x+"-cursor";customizedCanvas[x]={data:{state:"",undo:[],redo:[]},canvas:new fabric.Canvas(x,{isDrawingMode:!1,freeDrawingCursor:"none"}),cursorCanvas:new fabric.StaticCanvas(e)};var y=new fabric.Circle({left:-100,top:-100,radius:.5*commonSetting.brushWidth+3,fill:"rgba(255,255,255)",opacity:.6,stroke:"transparent",originX:"center",originY:"center"});setCanvasSize(x),customizedCanvas[x].canvas.setBackgroundColor("#383838",customizedCanvas[x].canvas.renderAll.bind(customizedCanvas[x].canvas)),customizedCanvas[x].cursorCanvas.add(y),customizedCanvas[x].canvas.on("selection:created",function(e){$.isMobile4()?"textbox"!=e.target.type?e.target.setControlVisible("editControl",!1):e.target.setControlVisible("editControl",!0):e.target.setControlVisible("editControl",!1),this.renderAll(),void 0!==e.e&&getColor(e)}),customizedCanvas[x].canvas.on("selection:updated",function(e){$.isMobile4()?"textbox"!=e.target.type?e.target.setControlVisible("editControl",!1):e.target.setControlVisible("editControl",!0):e.target.setControlVisible("editControl",!1),this.renderAll(),getColor(e)}),customizedCanvas[x].canvas.on("selection:cleared",function(){$(".object-control").remove(),"move"===activeTool||"brush"===activeTool?$('.tool-btn[data-tool="select"]').removeClass("active"):$('.tool-btn[data-tool="select"]').addClass("active"),"shape"!==activeTool&&"line"!==activeTool||(customizedCanvas[x].canvas.hoverCursor="crosshair")}),customizedCanvas[x].canvas.on("mouse:down",function(e){paper=$(".drawing-paper.show");var t=void 0,a=void 0,o=customizedCanvas[x].cursorCanvas,s=customizedCanvas[x].canvas.getActiveObject(),r=customizedCanvas[x].canvas.getPointer(e.e);if(isMouseDown=!0,$(".tool-btn").removeClass("open"),$(".tool-btn .tool-setting").fadeOut(300),$(".color-select").fadeOut(300),"brush"===activeTool&&y.set({top:r.y,left:r.x}).setCoords().canvas.renderAll(),s||selectable)switch(activeTool){case"brush":$('.type-box[data-option="stroke"]').addClass("disabled"),$('.color-box[data-option="stroke"]').addClass("disabled");break;case"text":isEdit=!0}else{isMouseDown=!0,origX=r.x,origY=r.y;var i=$(".drawing-paper.show").attr("data-page"),n=commonSetting.fillColor,l=commonSetting.strokeColor,c=r.x,d=r.y;switch(activeTool){case"text":$('.type-box[data-option="stroke"]').addClass("disabled"),$('.color-box[data-option="stroke"]').addClass("disabled"),$.isMobile4()?isEdit?isEdit=!1:($(".mobile-text-input").addClass("open"),$(".mobile-text-input .text-input").focus()):isEdit?isEdit=!1:(addTextBox(i,"",c,d,n),$('.tool-btn[data-tool="select"]').removeClass("active"));break;case"shape":addShape(i,$(".setting-wrap .shape-btn.active").attr("data-option"),c,d,n,l);break;case"line":var v=[r.x,r.y,r.x,r.y],p=$(".setting-wrap .line-btn.active").attr("data-option");$('.type-box[data-option="stroke"]').addClass("disabled"),$('.color-box[data-option="stroke"]').addClass("disabled"),addLine(i,p,v,n)}}moveMode&&("touchstart"===e.e.type?(t=e.e.targetTouches[0].clientX,a=e.e.targetTouches[0].clientY):(t=e.e.clientX,a=e.e.clientY),paper.removeClass("move").addClass("moving"),this.lastPosX=t,o.lastPosX=t,this.lastPosY=a,o.lastPosY=a)}),customizedCanvas[x].canvas.on("mouse:move",function(e){var t=void 0,a=void 0,o=this,s=customizedCanvas[x].cursorCanvas,r=customizedCanvas[x].canvas.getPointer(e.e);if("brush"===activeTool&&y.set({top:r.y,left:r.x}).setCoords().canvas.renderAll(),isMouseDown&&!o.getActiveObject()){switch(isDeleted=!1,activeTool){case"shape":var i=$(".setting-wrap .shape-btn.active").attr("data-option");if("rect"==i)origX>r.x&&rect.set({left:Math.abs(r.x)}),origY>r.y&&rect.set({top:Math.abs(r.y)}),rect.set({width:Math.abs(origX-r.x),height:Math.abs(origX-r.x)}),customizedCanvas[x].canvas.renderAll();else if("circle"==i){var n=Math.abs(origX-r.x)/2,l=Math.abs(origX-r.x)/2;n>ellipse.strokeWidth&&(n-=ellipse.strokeWidth/2),l>ellipse.strokeWidth&&(l-=ellipse.strokeWidth/2),ellipse.set({rx:n,ry:l}),origX>r.x?ellipse.set({originX:"right"}):ellipse.set({originX:"left"}),origY>r.y?ellipse.set({originY:"bottom"}):ellipse.set({originY:"top"}),customizedCanvas[x].canvas.renderAll()}break;case"line":var c=$(".setting-wrap .line-btn.active").attr("data-option");"straight-line"==c?(straightLine.set({x2:r.x,y2:r.y}),customizedCanvas[x].canvas.renderAll()):"arrow"==c&&(straightLine.set({x2:r.x,y2:r.y}),triangle.set({left:r.x+deltaX,top:r.y+deltaY,angle:fabricCalcArrowAngle(straightLine.x1,straightLine.y1,straightLine.x2,straightLine.y2)}),customizedCanvas[x].canvas.renderAll())}if(moveMode){var d=customizedCanvas[x].canvas.getZoom(),v=d-1,p=o.viewportTransform,b=s.viewportTransform,u=visualRange.width(),g=visualRange.height(),h=-(o.width-u)/2-v*o.width,m=(o.width-u)/2,f=-(o.height-g)/2-v*o.height,C=(o.height-g)/2,w=void 0,k=void 0;g/u<=1?(minScale=u/o.width,k=!0):1<g/u&&(minScale=g/o.height,w=!0),"touchmove"===e.e.type?(t=e.e.targetTouches[0].clientX,a=e.e.targetTouches[0].clientY):(t=e.e.clientX,a=e.e.clientY),p[4]+=t-o.lastPosX,b[4]+=t-s.lastPosX,p[5]+=a-o.lastPosY,b[5]+=a-s.lastPosY,d<=minScale?w?(p[4]>=m?(p[4]=m,b[4]=m):p[4]<=h&&(p[4]=h,b[4]=h),p[5]=(1-d)*o.height/2,b[5]=(1-d)*o.height/2):k&&(p[4]=(1-d)*o.width/2,b[4]=(1-d)*o.width/2,p[5]>=C?(p[5]=C,b[5]=C):p[5]<=f&&(p[5]=f,b[5]=f)):(p[4]>=m?(p[4]=m,b[4]=m):p[4]<=h&&(p[4]=h,b[4]=h),p[5]>=C?(p[5]=C,b[5]=C):p[5]<=f&&(p[5]=f,b[5]=f)),o.renderAll(),s.renderAll(),o.lastPosX=t,s.lastPosX=t,o.lastPosY=a,s.lastPosY=a}}}),customizedCanvas[x].canvas.on("mouse:up",function(e){var t=customizedCanvas[x].cursorCanvas,a=customizedCanvas[x].canvas.getPointer(e.e),o=customizedCanvas[x].canvas.getActiveObject();if(isMouseDown=!1,selectable||o)"text"===activeTool?setTimeout(function(){e.target.isEditing&&$('.tool-btn[data-tool="select"]').removeClass("active")}):"brush"===activeTool&&saveCanvas();else if("select"!==activeTool&&"move"!==activeTool&&"text"!==activeTool&&a.x==origX&&a.y==origY)customizedCanvas[x].canvas.remove(activeObj),triangle&&customizedCanvas[x].canvas.remove(triangle),customizedCanvas[x].canvas.renderAll();else{if(("shape"===activeTool||"line"===activeTool)&&!isDeleted)if("line"===activeTool&&"arrow"==$(".line-btn.active").attr("data-option")){var s=[straightLine,triangle],r=new fabric.Group(s,{originX:"center",originY:"center",type:"arrowLine"});customizedCanvas[x].canvas.remove(straightLine,triangle),activeObj=r,customizedCanvas[x].canvas.add(r),customizedCanvas[x].canvas.setActiveObject(activeObj),customizedCanvas[x].canvas.renderAll()}else customizedCanvas[x].canvas.setActiveObject(activeObj),activeObj.setCoords(),customizedCanvas[x].canvas.renderAll();"text"!==activeTool&&saveCanvas()}moveMode&&(paper.removeClass("moving").addClass("move"),this.setViewportTransform(this.viewportTransform),t.setViewportTransform(t.viewportTransform))}),customizedCanvas[x].canvas.on("mouse:over",function(e){e.target&&("paperBG"===e.target.objType?customizedCanvas[x].canvas.hoverCursor="default":customizedCanvas[x].canvas.hoverCursor="move")}),customizedCanvas[x].canvas.on("mouse:out",function(){"brush"===activeTool&&y.set({top:-100,left:-100}).setCoords().canvas.renderAll(),"shape"!==activeTool&&"line"!==activeTool||$(".drawing-paper.show canvas.upper-canvas").css("cursor","crosshair")}),customizedCanvas[x].canvas.on("object:modified",function(e){saveCanvas()}),customizedCanvas[x].canvas.freeDrawingBrush&&(customizedCanvas[x].canvas.freeDrawingBrush.color=commonSetting.fillColor,customizedCanvas[x].canvas.freeDrawingBrush.width=parseInt(commonSetting.brushWidth))})}function paperMinimize(e){$(e).each(function(e,t){var a=$(".artboard-background").position().left+$(".artboard-background").innerWidth()/2,o=$(".artboard-background").position().top+$(".artboard-background").innerHeight()/2,s=t,r=visualRange.width(),i=visualRange.height(),n=roundDecimal(i/r*100,2),l=customizedCanvas[s].canvas.width,c=customizedCanvas[s].canvas.height,d=roundDecimal(c/l*100,2);nowScale=n<d?r/l:i/c,customizedCanvas[s].canvas.zoomToPoint({x:a,y:o},nowScale),customizedCanvas[s].cursorCanvas.zoomToPoint({x:a,y:o},nowScale)}),defaultViewport=customizedCanvas.default.canvas.viewportTransform}function drawPaperReset(){commonSetting.fillColor="#ffffff",commonSetting.strokeColor="transparent",commonSetting.brushWidth=5,moveMode=!(selectable=!0),isEdit=!(activeTool="select"),$(".tool-btn").removeClass("active"),$('.tool-btn[data-tool="select"]').addClass("active"),$(".setting-btn").removeClass("active"),$(".setting-btn.default").addClass("active"),$(".type-select .type-box").removeClass("disabled"),$('.type-select .type-box[data-option="stroke"]').addClass("disabled"),$(".tool-btn .color-box").removeClass("disabled"),$('.tool-btn .color-box[data-option="stroke"]').addClass("disabled"),$(".fill-color").css("background-color","#ffffff"),$(".display.stroke-color").css("border-color","transparent")}function getColor(e){var t=e.target.type,a=null==e.target.fill?"transparent":e.target.fill,o=e.target.stroke;switch($('.color-box[data-option="fill"]').removeClass("disabled"),$('.color-box[data-option="stroke"]').removeClass("disabled"),$('.type-box[data-option="fill"]').removeClass("disabled"),$('.type-box[data-option="stroke"]').removeClass("disabled"),t){case"path":commonSetting.fillColor=o,commonSetting.strokeColor="transparent",$(".fill-color").css("background-color",o),$(".stroke-color").css("border-color","transparent"),$('.color-box[data-option="stroke"]').addClass("disabled"),$('.type-box[data-option="stroke"]').addClass("disabled");break;case"textbox":commonSetting.fillColor=a,commonSetting.strokeColor="transparent",$(".fill-color").css("background-color",a),$(".stroke-color").css("border-color","transparent"),$('.color-box[data-option="stroke"]').addClass("disabled"),$('.type-box[data-option="stroke"]').addClass("disabled");break;case"line":commonSetting.fillColor=o,commonSetting.strokeColor="transparent",$(".fill-color").css("background-color",o),$(".stroke-color").css("border-color","transparent"),$('.color-box[data-option="stroke"]').addClass("disabled"),$('.type-box[data-option="stroke"]').addClass("disabled");break;case"arrowLine":var s=e.target._objects[0].fill;commonSetting.fillColor=s,commonSetting.strokeColor="transparent",$(".fill-color").css("background-color",s),$(".stroke-color").css("border-color","transparent"),$('.color-box[data-option="stroke"]').addClass("disabled"),$('.type-box[data-option="stroke"]').addClass("disabled");break;default:commonSetting.fillColor=a,commonSetting.strokeColor=o,$(".fill-color").css("background-color",a),$(".stroke-color").css("border-color",o),"transparent"==a&&($('.type-box[data-option="fill"]').addClass("disabled"),$('.color-box[data-option="fill"]').addClass("disabled")),"transparent"==o&&($('.type-box[data-option="stroke"]').addClass("disabled"),$('.color-box[data-option="stroke"]').addClass("disabled"))}}function toolSwitch(){$(".tool-btn").on("click",function(e){e.stopPropagation(),paper=$(".drawing-paper.show");var t=$(this).attr("data-tool"),a=$(this).find(".tool-setting"),o=$(".drawing-paper.show").attr("data-page"),s=customizedCanvas[o].canvas,r=s.getObjects();if(1<=r.length&&(r.forEach(function(e){"paperBG"===e.objType?e.selectable=!1:e.selectable=!0}),s.renderAll()),$(".tool-btn .tool-setting").fadeOut(300),"color"==t)$(this).hasClass("open")?($(this).removeClass("open"),$(".color-select").fadeOut(300)):($(".tool-btn .tool-setting").fadeOut(300),$(".tool-btn").removeClass("open"),$(this).addClass("open"),$(".color-select").fadeIn(300),$(".type-select .type-box").removeClass("active"),$('.type-select .type-box[data-option="fill"]').addClass("active"));else if($('.tool-btn:not([data-tool="color"])').removeClass("active"),$(this).addClass("active"),paper.removeClass("move"),s.isDrawingMode=!1,activeTool=t,isEdit=moveMode=!1,-1!=["select","move"].indexOf(t))switch(t){case"select":s.selection=!0,s.defaultCursor="default",customizedCanvas[o].canvas.getObjects()[0].hoverCursor="default",$(".tool-btn").removeClass("open"),s.isDrawingMode=!1,customizedCanvas[o].cursorCanvas._objects[0].set({opacity:0}).setCoords().canvas.renderAll();break;case"move":moveMode=!0,s.selection=!1,paper.addClass("move"),$(".tool-btn").removeClass("open"),$('.tool-btn[data-tool="select"]').removeClass("active"),s.isDrawingMode=!1,customizedCanvas[o].canvas.getObjects()[0].hoverCursor=null,customizedCanvas[o].cursorCanvas._objects[0].set({opacity:0}).setCoords().canvas.renderAll(),s.discardActiveObject(),s.renderAll(),1<=r.length&&(r.forEach(function(e){e.selectable=!1}),s.renderAll())}else if(-1!=["brush","text","shape","line"].indexOf(t))switch($('.tool-btn[data-tool="select"]').addClass("active"),$(".draw-tool").attr("data-select-tool",t),$(".color-select").fadeOut(300),"brush"!=activeTool&&(s.isDrawingMode=!1,customizedCanvas[o].cursorCanvas._objects[0].set({opacity:0}).setCoords().canvas.renderAll()),$(this).hasClass("open")?1<=a.length&&($(this).removeClass("open"),a.fadeOut(300)):($(".tool-btn").removeClass("open"),s.discardActiveObject(),s.renderAll(),1<=a.length&&($(this).addClass("open"),a.fadeIn(300))),"shape"!=t&&"transparent"!==commonSetting.strokeColor&&($('.type-select .type-box[data-option="stroke"]').addClass("disabled"),$('.tool-btn .color-box[data-option="stroke"]').addClass("disabled"),$(".display.stroke-color").css("border-color","transparent"),(commonSetting.strokeColor="transparent")===commonSetting.fillColor&&($('.type-select .type-box[data-option="fill"]').removeClass("disabled"),$('.tool-btn .color-box[data-option="fill"]').removeClass("disabled"),$(".fill-color").css("background-color","#ffffff"),commonSetting.fillColor="#ffffff")),t){case"brush":s.isDrawingMode=!0,selectable=!0,s.freeDrawingBrush.color=commonSetting.fillColor,s.getObjects()[0].hoverCursor=null,customizedCanvas[o].cursorCanvas._objects[0].set({opacity:.6,fill:commonSetting.fillColor}).setCoords().canvas.renderAll(),$('.tool-btn[data-tool="select"]').removeClass("active");break;case"text":selectable=!1,s.getObjects()[0].hoverCursor="text",s.defaultCursor="text";break;case"shape":case"line":s.selection=!1,selectable=!1,s.getObjects()[0].hoverCursor="crosshair",s.defaultCursor="crosshair"}})}function toolSetting(){$(".setting-wrap").on("click",function(e){e.stopPropagation()}),$(".setting-wrap .setting-btn").on("click",function(){var e=$(".drawing-paper.show").attr("data-page"),t=customizedCanvas[e].canvas;if($(this).siblings().removeClass("active"),$(this).addClass("active"),$(this).hasClass("brush-size")){var a=$(this).attr("data-size");commonSetting.brushWidth=parseInt(a),t.freeDrawingBrush.width=parseInt(a),customizedCanvas[e].cursorCanvas._objects[0].set({radius:.5*commonSetting.brushWidth+3}).setCoords().canvas.renderAll()}})}function colorSelect(){$(".color-wrap").on("click",function(e){e.stopPropagation()}),$(".color-palettes .colorBox").on("click",function(){var e=$(".drawing-paper.show").attr("data-page"),t=customizedCanvas[e],a=$(".type-select .type-box.active").attr("data-option"),o=$(this).css("background-color"),s=$(this).hasClass("disabled"),r=$(".type-select .type-box").hasClass("disabled"),i=t.canvas.getActiveObject();switch(a){case"fill":s?r||(commonSetting.fillColor="transparent",$('.type-select .type-box[data-option="fill"]').addClass("disabled"),$('.tool-btn .color-box[data-option="fill"]').addClass("disabled"),$(".display.fill-color").css("background-color","transparent"),i&&("rect"!=i.type&&"ellipse"!=i.type||(i.set({fill:"transparent"}),t.canvas.renderAll()))):(commonSetting.fillColor=RGBToHex(o),t.canvas.freeDrawingBrush.color=RGBToHex(o),$('.type-select .type-box[data-option="fill"]').removeClass("disabled"),$('.tool-btn .color-box[data-option="fill"]').removeClass("disabled"),$(".fill-color").css("background-color",o),t.cursorCanvas._objects[0].set({fill:o}),i&&("path"==i.type||"line"==i.type?i.set({stroke:RGBToHex(o)}):"arrowLine"==i.type?i._objects.forEach(function(e){e.set({fill:RGBToHex(o),stroke:RGBToHex(o)})}):i.set({fill:RGBToHex(o)}),t.canvas.renderAll()));break;case"stroke":s?r||(commonSetting.strokeColor="transparent",$('.type-select .type-box[data-option="stroke"]').addClass("disabled"),$('.tool-btn .color-box[data-option="stroke"]').addClass("disabled"),$(".display.stroke-color").css("border-color","transparent"),i&&("rect"!=i.type&&"ellipse"!=i.type||(i.set({stroke:"transparent"}),t.canvas.renderAll()))):(commonSetting.strokeColor=RGBToHex(o),$('.type-select .type-box[data-option="stroke"]').removeClass("disabled"),$('.tool-btn .color-box[data-option="stroke"]').removeClass("disabled"),$(".stroke-color").css("border-color",o),i&&("rect"!=i.type&&"ellipse"!=i.type||(i.set({stroke:RGBToHex(o)}),t.canvas.renderAll())))}saveCanvas()}),clickSwitchClass(".type-select .type-box","active"),clickSwitchClass(".shape-select .shape-btn","active")}function addTextBox(e,t,a,o,s){textBox=new fabric.Textbox(t,{objectCaching:!1,fontFamily:'"LibreBaskerville-Regular", "微軟正黑體修正", "Microsoft JhengHei", "微軟正黑體", sans-serif',left:a,top:o,fontSize:60,lineHeight:1.5,fill:s,editable:!$.isMobile4()}),customizedCanvas[e].canvas.add(textBox).setActiveObject(textBox),isEdit=!0,(activeObj=textBox).enterEditing()}function mobileTextBox(){$(".mobile-text-input .cancel-input").on("click",function(){$(".mobile-text-input").removeClass("open")}),$(".mobile-text-input .confirm-input").on("click",function(){var e=$(".drawing-paper.show").attr("data-page"),t=customizedCanvas[e].canvas,a=commonSetting.fillColor,o=$(".mobile-text-input .text-input").val();$(".mobile-text-input").removeClass("open"),""!==o.trim()&&(t.getActiveObject()?(t.getActiveObject().text=$(".mobile-text-input .text-input").val(),t.getActiveObject().width="",t.renderAll()):(addTextBox(e,o,origX,origY,a),$(".mobile-text-input .text-input").val(""),saveCanvas()))})}function addShape(e,t,a,o,s,r){switch(t){case"rect":rect=new fabric.Rect({left:a,top:o,width:0,height:0,strokeWidth:6,fill:s,stroke:r,transparentCorners:!1,strokeUniform:!0}),customizedCanvas[e].canvas.add(rect),activeObj=rect,isEdit=!0;break;case"circle":ellipse=new fabric.Ellipse({left:a,top:o,originX:"left",originY:"top",rx:0,ry:0,angle:0,fill:s,stroke:r,transparentCorners:!1,strokeWidth:6,type:"ellipse",strokeUniform:!0}),customizedCanvas[e].canvas.add(ellipse),activeObj=ellipse,isEdit=!0}}function addLine(e,t,a,o){switch(t){case"straight-line":straightLine=new fabric.Line(a,{strokeWidth:6,fill:o,stroke:o,originX:"center",originY:"center"}),customizedCanvas[e].canvas.add(straightLine),activeObj=straightLine,isEdit=!0;break;case"arrow":var s=((straightLine=new fabric.Line(a,{strokeWidth:6,fill:o,stroke:o,originX:"center",originY:"center"})).x1+straightLine.x2)/2,r=(straightLine.y1+straightLine.y2)/2;deltaX=straightLine.left-s,deltaY=straightLine.top-r,triangle=new fabric.Triangle({left:straightLine.get("x1")+deltaX,top:straightLine.get("y1")+deltaY,originX:"center",originY:"center",pointType:"arrow_start",angle:-45,width:30,height:30,fill:o}),customizedCanvas[e].canvas.add(straightLine,triangle),activeObj=straightLine,isEdit=!0}}function fabricCalcArrowAngle(e,t,a,o){var s,r;return r=o-t,180*(0===(s=a-e)?0===r?0:0<r?Math.PI/2:3*Math.PI/2:0===r?0<s?0:Math.PI:s<0?Math.atan(r/s)+Math.PI:r<0?Math.atan(r/s)+2*Math.PI:Math.atan(r/s))/Math.PI+90}function saveCanvas(){var e=(paper=$(".drawing-paper.show")).attr("data-page");customizedCanvas[e].data.undo.push(customizedCanvas[e].data.state),customizedCanvas[e].data.state=JSON.stringify(customizedCanvas[e].canvas),customizedCanvas[e].data.redo.length=0}function undoAndRedo(){$(".draw-step .step-btn").on("click",function(){var a=void 0,o=void 0,e=(paper=$(".drawing-paper.show")).attr("data-page"),s=customizedCanvas[e],t=$(this).attr("data-option"),r=$(this).attr("data-alert"),i=$(".artboard-background").innerWidth(),n=$(".artboard-background").innerHeight(),l=s.canvas.getObjects()[0];switch(t){case"undo":if(!s.data.undo.length)return void alert(r);var c=s.data.undo.pop();s.canvas.loadFromJSON(c,function(){if(a=$(".artboard-background").position().left,o=$(".artboard-background").position().top,"upload"!==l.objFrom)s.canvas.getObjects()[0].set({left:a,top:o,selectable:!1,objType:"paperBG",objFrom:"product"}).scale(i/s.canvas.getObjects()[0].width);else{var e=void 0,t=void 0;l.width>=l.height?(e=i/l.width,t=(n-l.height*e)/2,o+=t):l.width<l.height&&(e=n/l.height,t=(i-l.width*e)/2,a+=t),s.canvas.getObjects()[0].set({left:a,top:o,selectable:!1,objType:"paperBG",objFrom:"upload"}).scale(e)}s.canvas.renderAll()}),s.data.redo.push(s.data.state),s.data.state=c;break;case"redo":if(!s.data.redo.length)return void alert(r);var d=s.data.redo.pop();s.canvas.loadFromJSON(d,function(){if(a=$(".artboard-background").position().left,o=$(".artboard-background").position().top,"upload"!==l.objFrom)s.canvas.getObjects()[0].set({left:a,top:o,selectable:!1,objType:"paperBG",objFrom:"product"}).scale(i/s.canvas.getObjects()[0].width);else{var e=void 0,t=void 0;l.width>=l.height?(e=i/l.width,t=(n-l.height*e)/2,o+=t):l.width<l.height&&(e=n/l.height,t=(i-l.width*e)/2,a+=t),s.canvas.getObjects()[0].set({left:a,top:o,selectable:!1,objType:"paperBG",objFrom:"upload"}).scale(e)}s.canvas.renderAll()}),s.data.undo.push(s.data.state),s.data.state=d}})}function maximize(){$(".toolbar-top .maximize").on("click",function(){$(".all-wrapper").toggleClass("extend"),paperMinimize(canvasName)})}function drawPaperSwitch(o){var s=customizedCanvas[o].canvas;s.discardActiveObject(),s.renderAll(),$(".drawing-paper.show").animate({opacity:"0"},300,function(){switch($(".bg-select .item").removeClass("active"),$('.bg-select .item[data-page="'+o+'"]').addClass("active selected"),$(".drawing-paper").removeClass("show"),$(".drawing-paper").css("z-index","-1"),$(".drawing-paper").css("opacity","1"),$('.drawing-paper[data-page="'+o+'"]').css({"z-index":"1"}).addClass("show"),o){case"default":var e=$(".product-name span:nth-child(2)").attr("data-default");$(".product-name span:nth-child(2)").text(e);break;case"attached1":$(".product-name span:nth-child(2)").text("Attached file-1");break;case"attached2":$(".product-name span:nth-child(2)").text("Attached file-2")}var t=$(".drawing-paper.show"),a=s.getObjects();switch(t.removeClass("move"),s.isDrawingMode=!1,s.selection=!1,s.freeDrawingBrush.color=commonSetting.fillColor,s.freeDrawingBrush.width=commonSetting.brushWidth,customizedCanvas[o].cursorCanvas._objects[0].set({fill:commonSetting.fillColor}),1<=a.length&&(a.forEach(function(e){"paperBG"===e.objType?e.selectable=!1:e.selectable=!0}),s.renderAll()),activeTool){case"select":s.selection=!0,s.defaultCursor="default";break;case"move":moveMode=!0,t.addClass("move"),1<=a.length&&(a.forEach(function(e){"paperBG"===e.objType?e.selectable=!1:e.selectable=!0}),s.renderAll());break;case"brush":s.isDrawingMode=!0,selectable=!0;break;case"text":selectable=!1,s.getObjects()[0].hoverCursor="text",s.defaultCursor="text";break;case"shape":case"line":selectable=!1,s.getObjects()[0].hoverCursor="crosshair",s.defaultCursor="crosshair"}})}function selectPaperHandler(){$(".bg-select .item").on("click",function(){var e=$(this),t=e.attr("data-page");e.hasClass("selected")?"0"==!$('.drawing-paper[data-page="'+t+'"]').css("opacity")&&drawPaperSwitch(t):($(".visual-range .select-background").attr("data-id",t),$(".visual-range .select-background").is(":visible")||$(".visual-range .select-background").css("display","flex").hide().fadeIn(300),$(".favorite-block").is(":visible")&&$(".favorite-block").fadeOut(300).promise().done(function(){$(".remark-block").show(),$(".select-from > div:not(.favorite)").show(),$(".select-background .back-btn").show()}))})}function selectBGHandler(){$(".visual-range .select-background .back-btn").on("click",function(){$(".select-from .item.upload").is(":visible")?$(".visual-range .select-background").fadeOut(300):$(".favorite-block").fadeOut(300).promise().done(function(){$(".remark-block").show(),$(".select-from > div:not(.favorite)").show()})}),$("#uploadBG").change(function(){var t=$(".visual-range .select-background").attr("data-id");if(this.files&&this.files[0]){var e=new FileReader,a=new Image,o=window.URL||window.webkitURL,s=o.createObjectURL(this.files[0]);e.onload=function(e){a.onload=function(){addPaperBackground(t,e.target.result,"upload"),$('.bg-select .item[data-page="'+t+'"]').css("background-image","url("+e.target.result+")"),$(".visual-range .select-background").fadeOut(300),drawPaperSwitch(t),o.revokeObjectURL(s)},a.src=s},e.readAsDataURL(this.files[0])}}),$(".select-background .select-from .item.favorite").on("click",function(){var e=$(window).outerWidth();$(".select-background .select-from > div").not(this).hide(),$(".remark-block").fadeOut(300).promise().done(function(){$(".favorite-block").show(),($(".all-wrapper").hasClass("extend")||e<1366)&&($(".select-background").hide(),$(".other-wrap").addClass("overlay select-product"),$(".other-wrap").css("z-index","5"),$(".other-wrap .block").on("transitionend webkitTransitionEnd oTransitionEnd",function(){$(".close-favorite").css("z-index","6"),$(".other-wrap .block").unbind("transitionend webkitTransitionEnd oTransitionEnd")}))})}),$(".favorite-block").on("click",".product-list .item",function(){var e=$(window).outerWidth(),t=$(".visual-range .select-background").attr("data-id"),a=$(this).find(".img-box").css("background-image").replace(/^url\(['"](.+)['"]\)/,"$1");addPaperBackground(t,a,"product"),$('.bg-select .item[data-page="'+t+'"]').css("background-image","url("+a+")"),$(".visual-range .select-background").fadeOut(300),$(".favorite-block").fadeOut(300).promise().done(function(){$(".remark-block").show(),$(".select-background .select-from > div").show(),$(".select-background .back-btn").show(),$(".all-wrapper").hasClass("extend")||e<1366?($(".other-wrap").removeClass("overlay select-product"),$(".other-wrap .block").on("transitionend webkitTransitionEnd oTransitionEnd",function(){$(".close-favorite").css("z-index",""),$(".other-wrap").css("z-index",""),$(".other-wrap .block").unbind("transitionend webkitTransitionEnd oTransitionEnd")})):($(".select-background .select-from > div:not(.favorite)").show(),$(".select-background .back-btn").show())}),drawPaperSwitch(t)})}function deletePaper(){$(".delete-paper").on("click",function(e){e.stopPropagation();var t=$(this).parents(".item").attr("data-page");switch(t){case"attached1":$(".paper-delete-check .title .paper-name").attr("data-name","Attached file-1");break;case"attached2":$(".paper-delete-check .title .paper-name").attr("data-name","Attached file-2")}$(".paper-delete-check").attr("data-page",t).fadeIn(300)}),$(".paper-delete-check .btn-group .btn.no").on("click",function(){$(".paper-delete-check").fadeOut(300)}),$(".paper-delete-check .btn-group .btn.yes").on("click",function(){var e=$(this).parents(".paper-delete-check").attr("data-page");switch($(".paper-delete-check").fadeOut(300),customizedCanvas[e].canvas.clear(),$('.drawing-paper[data-page="'+e+'"]').removeClass("paper-initialize"),$('.bg-select .item[data-page="'+e+'"]').css("background-image","").removeClass("selected active"),$("#uploadBG").val(""),e){case"attached1":drawPaperSwitch("default");break;case"attached2":$('.bg-select .item[data-page="attached1"]').hasClass("selected")?drawPaperSwitch("attached1"):drawPaperSwitch("default")}})}function paperScaleHandler(){var c=$(".artboard-background").position().left+$(".artboard-background").innerWidth()/2,d=$(".artboard-background").position().top+$(".artboard-background").innerHeight()/2,v=0,p=1;$(".toolbar-left .zoom").on("click",function(){var e=$(this).attr("data-option"),t=$(this).attr("data-alert"),a=(paper=$(".drawing-paper.show")).attr("data-page");switch(e){case"zoom-in":nowScale+.2<1.8?nowScale+=.2:1.8<nowScale+.2&&(nowScale=1.8,1<(v+=1)&&alert(t)),p=0,customizedCanvas[a].canvas.zoomToPoint({x:c,y:d},nowScale),customizedCanvas[a].cursorCanvas.zoomToPoint({x:c,y:d},nowScale);break;case"zoom-out":var o=visualRange.width(),s=visualRange.height(),r=roundDecimal(s/o*100,2),i=customizedCanvas[a].canvas.width,n=customizedCanvas[a].canvas.height,l=roundDecimal(n/i*100,2);o<i*(nowScale-.2)&&s<n*(nowScale-.2)?nowScale-=.2:(nowScale=r<l?o/i:s/n,1<(p+=1)&&alert(t)),v=0,customizedCanvas[a].canvas.zoomToPoint({x:c,y:d},nowScale),customizedCanvas[a].cursorCanvas.zoomToPoint({x:c,y:d},nowScale)}})}var paper=$(".drawing-paper.show"),visualRange=$(".visual-range"),defaultSrc=$('.drawing-paper[data-page="default"]').attr("data-src"),nowScale=1,canvasName=["default","attached1","attached2"],commonSetting={fillColor:"#ffffff",strokeColor:"transparent",brushWidth:5},customizedCanvas={},isMouseDown=void 0,textBox=void 0,rect=void 0,ellipse=void 0,straightLine=void 0,triangle=void 0,origX=void 0,origY=void 0,deltaX=void 0,deltaY=void 0,activeObj=void 0,defaultViewport=void 0,minScale=void 0,selectable=!0,isDeleted=!1,moveMode=!1,activeTool="select",isEdit=!1;setTimeout(function(){clickBlank(),fabricInit(canvasName),paperMinimize(canvasName),paperScaleHandler(),toolSwitch(),toolSetting(),colorSelect(),maximize(),selectPaperHandler(),selectBGHandler(),deletePaper(),undoAndRedo(),mobileTextBox(),addPaperBackground("default",defaultSrc,"product")},300),$(window).resize4("resizeBG",300);
//# sourceMappingURL=customized-dist.js.map